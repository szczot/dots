(window.webpackChunk=window.webpackChunk||[]).push([[717],{32528:(e,t,i)=>{"use strict";i.r(t),i.d(t,{SnippetsFeature:()=>D,SnippetsRpcClient:()=>T,SnippetsUIController:()=>A,processChanges:()=>b});var s=i(95300),n=i(2844),r=i(77176),p=i(38194),h=i(93508),a=i(41398),l=i(85985),c=i(78674),o=i(62337),d=i(13116),g=i(55073),u=i(90361);function _(){return{items:[],children:new Map}}function S(e,t){return t&&0!==e.length?S(e.slice(1),t.children.get(e[0])||null):t}class x{constructor(e,t){this._root=_(),e.forEach((e=>{const i=e[t];if(!function(e){return"string"==typeof e}(i))throw new Error("Can't search for non-string attributes");i.toLowerCase().split("").reduce(((t,i)=>(t.items.push(e),t.children.has(i)||t.children.set(i,_()),t.children.get(i))),this._root).items.push(e)}))}search(e){const t=[];let i=null,s={node:this._root,depth:0};const n=[];for(;s;){i=S(e.toLowerCase(),s.node),i&&n.push({node:i,depth:s.depth});const r=s.node.children.values();let p=r.next();for(;!p.done;)t.push({node:p.value,depth:s.depth+1}),p=r.next();s=t.shift()||null}return Array.from(n.reduce(((t,i)=>(i.node.items.forEach((s=>{t.has(s)||t.set(s,{start:i.depth,end:i.depth+e.length})})),t)),new Map).entries()).map((([e,t])=>({item:e,range:t})))}}var m=i(75420),v=i(74850),f=i(36991),y=i(84966);const C=new RegExp(`^(.*\\s)?${(0,u.hr)("\\")}(\\s.*)?$`),w=/\s+$/;function b(e,t,i="\\",s=C){if(!t){if(e.deltaChange.isEmpty)return null;{const t=e.deltaChange.delta.ops.slice(0);let n=t.pop();for(;t.length&&n&&!f.s.isInsertString(n);)n=t.pop();if(n&&f.s.isInsertString(n)&&!w.test(n.insert)){const t=e.deltaChange.delta.ops.reduce(((e,t)=>f.s.isInsertString(t)?e+t.insert.length:f.s.isRetain(t)?e+t.retain:e),0);return s.test((0,g.l)(e.deltaChange.delta,e.prevText).slice(Math.max(t-i.length-1,0),t+1))?{start:t-i.length,end:t}:null}return null}}{const{effectStartIndex:s,sizeDelta:n}=e.deltaChange.delta.ops.reduce(((e,t)=>(f.s.isRetain(t)?e.index+=t.retain:f.s.isDelete(t)?(e.effectStartIndex=Math.min(e.effectStartIndex,e.index),e.sizeDelta-=t.delete):f.s.isInsertString(t)?(e.effectStartIndex=Math.min(e.effectStartIndex,e.index),e.index+=t.insert.length,e.sizeDelta+=t.insert.length):f.s.isInsertEmbed(t)&&(e.effectStartIndex=Math.min(e.effectStartIndex,e.index),e.index+=1,e.sizeDelta+=1),e)),{index:0,effectStartIndex:1/0,sizeDelta:0});switch(!0){case s<t.start+i.length:case s>t.end:return null;default:return{...t,end:t.end+n}}}}class D{constructor(e,t,i,g,_,S,f,y,C,w,D,k=v.Y.create("Snippets")){this._rpcClient=e,this._textObserver=t,this._replacementService=i,this._geometryProvider=g,this._geometryLayout=_,this._textFieldLayout=S,this._getCurrentTextMap=f,this._controller=y,this._keyDown=C,this._gnar=w,this._checkingService=D,this._log=k,this._insertionRange=new s.X(null),this._activeSnippet=new s.X(null),this._subs=[],this.snippets=(0,n.aj)([this._insertionRange,this._activeSnippet,this._textFieldLayout.rect.behavior]).pipe((0,r.U)((([e,t,i])=>{if(e){const i=this._getCurrentTextMap(),s=e&&this._geometryProvider.create(e,i),n=this._geometryProvider.getClientRects(s);if(n&&n[0]){const s=this._getSnippetsForText(i.getPlainText().substring(e.start+this._triggerSequence.length,e.end)),r=t?s.findIndex((e=>e.snippet.id===t.id)):-1;return{rect:(0,d.Z)(o.UL.setPosition(this._geometryLayout.getApproximateConversionContext().clientToRelative(n[0]),n[0]),this._textFieldLayout.rect.getApproximate().client,this._textFieldLayout.scroll.getApproximate()),matches:s,applySnippet:t=>{this._applySnippet(t,e)},selectSnippet:e=>{this._selectSnippet(e)},activeSnippet:s.length?t&&r>-1?{snippet:t,index:r}:{snippet:s[0].snippet,index:0}:null,matchLength:e.end-e.start-this._triggerSequence.length,triggerSequence:this._triggerSequence}}return null}return null})),(0,p.B)(),(0,h.O)(null)),this._snippetsData=new x([],"name"),Promise.all([this._rpcClient.load(),this._rpcClient.getTrigger()]).then((([e,t])=>{this._triggerSequence=t||"\\",this._triggerRegexp=new RegExp(`^(.*\\s)?${(0,u.hr)(this._triggerSequence)}(\\s.*)?$`),this._gnar.snippetsListLoaded(e.length),e.length?(this._snippetsData=new x(e,"name"),this._subs.push(this.snippets.subscribe((e=>{e?this._controller.show(e):this._controller.hide()}))),this._subs.push(this._textObserver.contentChanges.async.pipe((0,a.M)(this._insertionRange.pipe((0,h.O)(null))),(0,r.U)((([e,t])=>{const i=b(e,t,this._triggerSequence,this._triggerRegexp);this._insertionRange.next(i),t&&null===i&&this._dismiss("edit"),null===t&&i&&this._gnar.snippetsListPresented(this._triggerSequence)}))).subscribe()),this._subs.push(this._keyDown.pipe((0,a.M)(this._insertionRange,this.snippets),(0,l.h)((([e,t])=>null!==t))).subscribe((([e,t,i])=>{e.keyCode===m.VD.Escape?this._dismiss("esc"):e.keyCode!==m.VD.Tab&&e.keyCode!==m.VD.RightArrow&&e.keyCode!==m.VD.Return||e.altKey||e.ctrlKey||e.shiftKey||e.metaKey?e.keyCode!==m.VD.UpArrow&&e.keyCode!==m.VD.DownArrow||(e.preventDefault(),this._shiftActiveSnippet(e.keyCode===m.VD.UpArrow,i)):t&&i&&i.activeSnippet&&(e.preventDefault(),this._applySnippet(i.activeSnippet.snippet,t))}))),this._subs.push(this._textFieldLayout.scroll.behavior.pipe((0,a.M)(this.snippets),(0,l.h)((([e,t])=>!!t))).subscribe((()=>{this._dismiss("scroll")}))),this._subs.push((0,n.aj)(this._controller.cardHovered,this._insertionRange,this._activeSnippet).pipe((0,c.b)(5e3)).subscribe((([e,t,i])=>{!e&&t&&this._dismiss("timeout")})))):this._log.warn("Empty snippets list, doing nothing")})).catch((e=>{this._log.warn("Could not intialize",e)})),this._gnar.snippetsFeatureInit()}_applySnippet(e,t){this._dismiss("apply"),this._gnar.snippetsSnippetApplied(t.end-t.start-this._triggerSequence.length),this._replacementService.performReplacement(t,e.content,!1),this._checkingService&&this._checkingService.onSnippetFeedback({kind:y.JE.SNIPPET_ACCEPTED,snippetUuid:e.id})}_selectSnippet(e){this._activeSnippet.next(e)}_getSnippetsForText(e){return this._snippetsData.search(e).slice(0,30).map((e=>({snippet:e.item,range:e.range})))}_shiftActiveSnippet(e,t){var i;if(t&&t.matches.length&&t.activeSnippet){const s=t.activeSnippet.index;s>-1?this._activeSnippet.next((null===(i=t.matches[Math.min(t.matches.length-1,Math.max(s+(e?-1:1),0))])||void 0===i?void 0:i.snippet)||null):this._activeSnippet.next(null)}else this._activeSnippet.next(null)}_dismiss(e){this._insertionRange.next(null),this._activeSnippet.next(null),"apply"!==e&&this._gnar.snippetsListDismissed(e)}dispose(){this._subs.forEach((e=>e.unsubscribe()))}}var k=i(27378),L=i(32952),R=i(28043),M=i(38983),I=i(25691),E=i(88434);class A{constructor(e){this._gnar=e,this._hovered=new L.xQ,this._dismissed=new L.xQ,this.cardHovered=this._hovered.pipe((0,h.O)(!1),(0,R.x)()),this.cardDismissed=this._dismissed.pipe((0,R.x)()),this._activeCardModel=M.h.create(null),this.view=(0,n.aj)([this._activeCardModel]).pipe((0,r.U)((([e])=>e?k.createElement(I.W,{anchorRect:e.rect,anchorMargin:{top:0,left:-15,bottom:5,right:0},onHover:e=>this._hovered.next(e),onClickAway:e=>this._dismissed.next(e),partName:"snippets"},k.createElement(E.L,{matches:e.matches,applySnippet:e.applySnippet,selectSnippet:e.selectSnippet,activeSnippet:e.activeSnippet,triggerSequence:e.triggerSequence,onOpenLink:e=>this._onOpenLink(e)})):null)))}_onOpenLink(e){this._gnar.snippetsLinkOpened(e)}show(e){this._activeCardModel.set(e)}hide(){this._activeCardModel.set(null),this._hovered.next(!1)}dispose(){this.hide()}}class T{constructor(e){this._rpc=e,this.load=this._rpc.loadSnippets,this.getTrigger=this._rpc.getSnippetsTrigger}}}}]);